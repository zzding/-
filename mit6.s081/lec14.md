# 1、xv6文件系统
## 难点：
- 文件系统需要在磁盘上使用数据结构来表示命名目录和文件的树形结构，记录每个文件内容所在的块的标识，并记录磁盘上哪些区域是空闲的。
- 文件系统必须支持崩溃恢复。也就是说，如果发生崩溃（例如电源故障），文件系统必须在重新启动后正确工作。  
风险在于崩溃可能中断一系列更新操作，并导致不一致的磁盘上的数据结构（例如，一个既被文件使用又被标记为空闲的块）。
- 不同的进程可能同时对文件系统进行操作，因此文件系统代码必须协调工作以保持不变性。
- 访问磁盘的速度比访问内存慢几个数量级，因此文件系统必须维护一个内存中的热门块缓存。


# 2、文件层次
|      层次        |    描述    |    
|-----------------|-------------|
| File Descriptor |用文件系统接口来抽象许多Unix资源（例如管道、设备、文件等），简化应用程序员的工作|
|   Pathname      |提供类似于"/usr/rtm/xv6/fs.c"的层次化路径名，并通过递归查找解析它们|
|   Directory     |一系列目录项，每个目录项包含文件的名称和i节点号|
|     Inode       |层提供单个文件，每个文件由一个唯一的i节点和一些保存文件数据的块组成|
|    Logging      |允许较高层将对多个块的更新封装为事务，并确保在崩溃的情况下以原子方式更新这些块|
| Buffer Cache    |缓存层缓存磁盘块并同步对它们的访问，确保一次只有一个内核进程可以修改任何特定块中存储的数据|
|      Disk       |读取和写入virtio硬盘上的块|


# 3、磁盘分布
文件系统不使用块0（它保存引导扇区）。  
块1称为超级块，它包含关于文件系统的元数据（文件系统大小（以块为单位）、数据块数量、i节点数量和日志中的块数量）。  
从块2开始是日志块。日志之后是i节点，每个块包含多个i节点。  
之后是跟踪使用的数据块的位图块。  
剩下的块是数据块；每个数据块在位图块中标记为可用或者保存文件或目录的内容。超级块由一个名为mkfs的单独程序填充，该程序构建初始文件系统。  
| boot | super | log | inodes | bit map | data .... data |
|------|-------|-----|--------|---------|----------------|
|0|1|2|


# 4、缓存区
- 同步访问磁盘块，确保内存中只有一个块的副本，并且同一时间只有一个内核线程使用该副本
- 缓存常用的块，以避免需要从缓慢的磁盘重新读取。相关代码位于bio.c文件中

## 字段
- valid字段表示缓冲区是否包含块的副本。
- disk字段表示缓冲区的内容已经交给磁盘，磁盘可能会改变缓冲区的内容

## bread，bwrite
一旦bread从磁盘读取（如果需要）并将缓冲区返回给调用者，调用者就独占了该缓冲区，并可以读取或写入数据字节。如果调用者修改了缓冲区，必须在释放缓冲区之前调用bwrite将更改后的数据写入磁盘。